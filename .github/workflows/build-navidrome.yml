name: Build Navidrome RPi4

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 0'

permissions:
  contents: write
  packages: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      rebuild: ${{ steps.check.outputs.rebuild }}
      
      # Versions (Commit SHAs)
      navidrome_ver: ${{ steps.get_navidrome.outputs.sha }}
      ffmpeg_ver: ${{ steps.get_ffmpeg.outputs.sha }}
      opus_ver: ${{ steps.get_opus.outputs.sha }}
      lame_ver: ${{ steps.get_lame.outputs.sha }}
      taglib_ver: ${{ steps.get_taglib.outputs.sha }}
      distroless_digest: ${{ steps.get_distroless.outputs.digest }}
      
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 1. Fetch Latest Commits (Bleeding Edge)
      # -----------------------------------------------------------------------
      
      # Navidrome (Master/Main)
      - name: Get latest Navidrome (HEAD)
        id: get_navidrome
        run: |
          SHA=$(git ls-remote https://github.com/navidrome/navidrome.git HEAD | awk '{print $1}')
          if [ -z "$SHA" ]; then echo "Failed to get Navidrome SHA"; exit 1; fi
          echo "sha=${SHA}" >> $GITHUB_OUTPUT

      # FFmpeg (Master)
      - name: Get latest FFmpeg (HEAD)
        id: get_ffmpeg
        run: |
           SHA=$(git ls-remote https://git.ffmpeg.org/ffmpeg.git HEAD | awk '{print $1}')
           if [ -z "$SHA" ]; then echo "Failed to get FFmpeg SHA"; exit 1; fi
           echo "sha=${SHA}" >> $GITHUB_OUTPUT

      # Opus (Master)
      - name: Get latest Opus (HEAD)
        id: get_opus
        run: |
           SHA=$(git ls-remote https://github.com/xiph/opus.git HEAD | awk '{print $1}')
           if [ -z "$SHA" ]; then echo "Failed to get Opus SHA"; exit 1; fi
           echo "sha=${SHA}" >> $GITHUB_OUTPUT

      # Lame (Master - Debian Salsa)
      - name: Get latest Lame (HEAD)
        id: get_lame
        run: |
           # Using Debian Salsa Multimedia Team repo
           SHA=$(git ls-remote https://salsa.debian.org/multimedia-team/lame.git HEAD | awk '{print $1}')
           if [ -z "$SHA" ]; then echo "Failed to get Lame SHA"; exit 1; fi
           echo "sha=${SHA}" >> $GITHUB_OUTPUT

      # TagLib (Master)
      - name: Get latest TagLib (HEAD)
        id: get_taglib
        run: |
           SHA=$(git ls-remote https://github.com/taglib/taglib.git HEAD | awk '{print $1}')
           if [ -z "$SHA" ]; then echo "Failed to get TagLib SHA"; exit 1; fi
           echo "sha=${SHA}" >> $GITHUB_OUTPUT

      # Distroless
      - name: Get Distroless Digest
        id: get_distroless
        run: |
          DIGEST=$(docker manifest inspect gcr.io/distroless/cc-debian13:latest | jq -r '.manifests[0].digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # 2. Compare with Stored
      # -----------------------------------------------------------------------
      - name: Check for Changes
        id: check
        run: |
            FILE="package-versions.txt"
            CHANGED=false
            
            check_ver() {
               NAME=$1
               NEW=$2
               OLD=$(grep "^${NAME}-" $FILE | sed "s/^${NAME}-//")
               
               if [ "$NEW" != "$OLD" ]; then
                  echo "NEW $NAME: $NEW (was $OLD)"
                  return 0
               fi
               return 1
            }

            if check_ver "navidrome" "${{ steps.get_navidrome.outputs.sha }}"; then CHANGED=true; fi
            if check_ver "ffmpeg" "${{ steps.get_ffmpeg.outputs.sha }}"; then CHANGED=true; fi
            if check_ver "opus" "${{ steps.get_opus.outputs.sha }}"; then CHANGED=true; fi
            if check_ver "mp3lame" "${{ steps.get_lame.outputs.sha }}"; then CHANGED=true; fi
            if check_ver "taglib" "${{ steps.get_taglib.outputs.sha }}"; then CHANGED=true; fi
            if check_ver "distroless" "${{ steps.get_distroless.outputs.digest }}"; then CHANGED=true; fi

            if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                CHANGED=true
            fi

            echo "rebuild=$CHANGED" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Build (RPi4 Optimized)
  # ---------------------------------------------------------------------------
  build-rpi4:
    needs: check-versions
    if: needs.check-versions.outputs.rebuild == 'true'
    # Native ARM64 Runner
    runs-on: ubuntu-24.04-arm
    env:
      IMAGE_NAME: navidrome
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          # Tags: latest and rpi4
          tags: |
            ghcr.io/${{ github.repository_owner }}/navidrome:latest
            ghcr.io/${{ github.repository_owner }}/navidrome:rpi4
          build-args: |
             NAVIDROME_VERSION=${{ needs.check-versions.outputs.navidrome_ver }}
             FFMPEG_VERSION=${{ needs.check-versions.outputs.ffmpeg_ver }}
             OPUS_VERSION=${{ needs.check-versions.outputs.opus_ver }}
             MP3LAME_VERSION=${{ needs.check-versions.outputs.lame_ver }}
             TAGLIB_VERSION=${{ needs.check-versions.outputs.taglib_ver }}
             # A72 Optimization
             CFLAGS=-O3 -mcpu=cortex-a72 -fstack-protector-strong -D_FORTIFY_SOURCE=2
             CXXFLAGS=-O3 -mcpu=cortex-a72 -fstack-protector-strong -D_FORTIFY_SOURCE=2
          platforms: linux/arm64
          provenance: false
          cache-from: type=gha,scope=rpi4
          cache-to: type=gha,mode=max,scope=rpi4

  # ---------------------------------------------------------------------------
  # Update Repo
  # ---------------------------------------------------------------------------
  update-repo:
      needs: [check-versions, build-rpi4]
      if: always() && needs.build-rpi4.result == 'success'
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Update versions file
          run: |
             FILE="package-versions.txt"
             
             echo "# Navidrome Build Versions" > $FILE
             echo "" >> $FILE
             echo "# Main App" >> $FILE
             echo "navidrome-${{ needs.check-versions.outputs.navidrome_ver }}" >> $FILE
             echo "ffmpeg-${{ needs.check-versions.outputs.ffmpeg_ver }}" >> $FILE
             echo "" >> $FILE
             echo "# Libraries" >> $FILE
             echo "opus-${{ needs.check-versions.outputs.opus_ver }}" >> $FILE
             echo "mp3lame-${{ needs.check-versions.outputs.lame_ver }}" >> $FILE
             echo "taglib-${{ needs.check-versions.outputs.taglib_ver }}" >> $FILE
             echo "" >> $FILE
             echo "# Base" >> $FILE
             echo "distroless-${{ needs.check-versions.outputs.distroless_digest }}" >> $FILE
             
             git config --global user.name 'github-actions[bot]'
             git config --global user.email 'github-actions[bot]@users.noreply.github.com'
             git add $FILE
             if ! git diff --staged --quiet; then
                git commit -m "build(navidrome): Update versions"
                git push
             fi
